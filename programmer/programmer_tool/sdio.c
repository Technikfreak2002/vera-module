#include "sdio.h"
#include "lib.h"
#include "usb.h"

uint8_t CRCTable[256] =
    "\x00\x09\x12\x1b\x24\x2d\x36\x3f\x48\x41\x5a\x53\x6c\x65\x7e\x77"
    "\x19\x10\x0b\x02\x3d\x34\x2f\x26\x51\x58\x43\x4a\x75\x7c\x67\x6e"
    "\x32\x3b\x20\x29\x16\x1f\x04\x0d\x7a\x73\x68\x61\x5e\x57\x4c\x45"
    "\x2b\x22\x39\x30\x0f\x06\x1d\x14\x63\x6a\x71\x78\x47\x4e\x55\x5c"
    "\x64\x6d\x76\x7f\x40\x49\x52\x5b\x2c\x25\x3e\x37\x08\x01\x1a\x13"
    "\x7d\x74\x6f\x66\x59\x50\x4b\x42\x35\x3c\x27\x2e\x11\x18\x03\x0a"
    "\x56\x5f\x44\x4d\x72\x7b\x60\x69\x1e\x17\x0c\x05\x3a\x33\x28\x21"
    "\x4f\x46\x5d\x54\x6b\x62\x79\x70\x07\x0e\x15\x1c\x23\x2a\x31\x38"
    "\x41\x48\x53\x5a\x65\x6c\x77\x7e\x09\x00\x1b\x12\x2d\x24\x3f\x36"
    "\x58\x51\x4a\x43\x7c\x75\x6e\x67\x10\x19\x02\x0b\x34\x3d\x26\x2f"
    "\x73\x7a\x61\x68\x57\x5e\x45\x4c\x3b\x32\x29\x20\x1f\x16\x0d\x04"
    "\x6a\x63\x78\x71\x4e\x47\x5c\x55\x22\x2b\x30\x39\x06\x0f\x14\x1d"
    "\x25\x2c\x37\x3e\x01\x08\x13\x1a\x6d\x64\x7f\x76\x49\x40\x5b\x52"
    "\x3c\x35\x2e\x27\x18\x11\x0a\x03\x74\x7d\x66\x6f\x50\x59\x42\x4b"
    "\x17\x1e\x05\x0c\x33\x3a\x21\x28\x5f\x56\x4d\x44\x7b\x72\x69\x60"
    "\x0e\x07\x1c\x15\x2a\x23\x38\x31\x46\x4f\x54\x5d\x62\x6b\x70\x79";

void sdio_test(enum spi_mode spi_mode) {
    printf("Testing...\n");

    spi_set_mode(spi_mode);

    spi_transfer(NULL, NULL, 11);

    {
#define CMD0 (0x40 + 0) // GO_IDLE_STATE
        uint8_t buf[] = {CMD0, 0x00, 0x00, 0x00, 0x00, 0xCC, 0xFF, 0xFF};
        uint8_t c     = 0;
        for (unsigned i = 0; i < 5; i++) {
            c = CRCTable[(c << 1) ^ buf[i]];
        }
        buf[5] = c << 1 | 1;
        hexdump(buf, sizeof(buf));
        spi_select(true);
        spi_transfer(buf, buf, sizeof(buf));
        spi_select(false);
        hexdump(buf, sizeof(buf));
    }

    {
#define CMD8 (0x40 + 8) // SEND_IF_COND
        uint8_t buf[] = {CMD8, 0x00, 0x00, 0x01, 0xAA, 0xCC, 0xFF, 0xFF};
        uint8_t c     = 0;
        for (unsigned i = 0; i < 5; i++) {
            c = CRCTable[(c << 1) ^ buf[i]];
        }
        buf[5] = c << 1 | 1;
        hexdump(buf, sizeof(buf));
        spi_select(true);
        spi_transfer(buf, buf, sizeof(buf));
        spi_select(false);
        hexdump(buf, sizeof(buf));
    }

    spi_set_mode(SPI_MODE_NONE);
}
